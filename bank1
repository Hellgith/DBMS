-- Q.1: Create Tables and Insert Data

-- Create branch table first as others depend on it
CREATE TABLE branch (
    branch_name VARCHAR(50) PRIMARY KEY,
    branch_city VARCHAR(50) NOT NULL,
    assets DECIMAL(15, 2)
);

-- Create Account table
CREATE TABLE Account (
    Acc_no VARCHAR(20) PRIMARY KEY,
    branch_name VARCHAR(50),
    balance DECIMAL(15, 2) NOT NULL CHECK (balance >= 0),
    FOREIGN KEY (branch_name) REFERENCES branch (branch_name)
);

-- Create customer table
CREATE TABLE customer (
    cust_name VARCHAR(100) PRIMARY KEY,
    cust_street VARCHAR(100),
    cust_city VARCHAR(50)
);

-- Create Depositor table (linking customer and account)
CREATE TABLE Depositor (
    cust_name VARCHAR(100),
    acc_no VARCHAR(20),
    PRIMARY KEY (cust_name, acc_no),
    FOREIGN KEY (cust_name) REFERENCES customer (cust_name),
    FOREIGN KEY (acc_no) REFERENCES Account (Acc_no)
);

-- Create Loan table
CREATE TABLE Loan (
    loan_no VARCHAR(20) PRIMARY KEY,
    branch_name VARCHAR(50),
    amount DECIMAL(15, 2) NOT NULL CHECK (amount > 0),
    FOREIGN KEY (branch_name) REFERENCES branch (branch_name)
);

-- Create Borrower table (linking customer and loan)
CREATE TABLE Borrower (
    cust_name VARCHAR(100),
    loan_no VARCHAR(20),
    PRIMARY KEY (cust_name, loan_no),
    FOREIGN KEY (cust_name) REFERENCES customer (cust_name),
    FOREIGN KEY (loan_no) REFERENCES Loan (loan_no)
);

-- Insert Sample Data
INSERT INTO branch VALUES ('Akurdi', 'Pune', 5000000);
INSERT INTO branch VALUES ('Kothrud', 'Pune', 7000000);
INSERT INTO branch VALUES ('Thane', 'Mumbai', 9000000);

INSERT INTO Account VALUES ('A101', 'Akurdi', 50000);
INSERT INTO Account VALUES ('A102', 'Kothrud', 80000);
INSERT INTO Account VALUES ('A103', 'Akurdi', 120000);

INSERT INTO customer VALUES ('Amit', 'MG Road', 'Pune');
INSERT INTO customer VALUES ('Sunita', 'FC Road', 'Pune');
INSERT INTO customer VALUES ('Rahul', 'Link Road', 'Mumbai');

INSERT INTO Depositor VALUES ('Amit', 'A101');
INSERT INTO Depositor VALUES ('Sunita', 'A102');
INSERT INTO Depositor VALUES ('Amit', 'A103');

INSERT INTO Loan VALUES ('L201', 'Akurdi', 150000);
INSERT INTO Loan VALUES ('L202', 'Thane', 250000);
INSERT INTO Loan VALUES ('L203', 'Akurdi', 30000);

INSERT INTO Borrower VALUES ('Amit', 'L201');
INSERT INTO Borrower VALUES ('Rahul', 'L202');
INSERT INTO Borrower VALUES ('Sunita', 'L203');

-- Q.2: Create view/alias for customer table as cust
CREATE VIEW cust AS
SELECT * FROM customer;

-- Q.3: Add customer phone number in Customer table
ALTER TABLE customer
ADD phone_number VARCHAR(15);

-- Q.4: Delete phone number attribute from Customer table
ALTER TABLE customer
DROP COLUMN phone_number;

-- Q.5: Find the names of all branches in loan relation
SELECT DISTINCT branch_name
FROM Loan;

-- Q.6: Find all customers who have a loan - Find their names, loan_no and loan amount
SELECT b.cust_name, b.loan_no, l.amount
FROM Borrower b
JOIN Loan l ON b.loan_no = l.loan_no;

-- Q.7: List all customers in alphabetical order who have loan from Akurdi branch
SELECT b.cust_name
FROM Borrower b
JOIN Loan l ON b.loan_no = l.loan_no
WHERE l.branch_name = 'Akurdi'
ORDER BY b.cust_name;

-- Q.8: Find average account balance at Akurdi branch
SELECT AVG(balance) AS avg_balance_akurdi
FROM Account
WHERE branch_name = 'Akurdi';

-- Q.9: Find no. of depositors at each branch
SELECT a.branch_name, COUNT(DISTINCT d.cust_name) AS num_depositors
FROM Account a
JOIN Depositor d ON a.Acc_no = d.acc_no
GROUP BY a.branch_name;
